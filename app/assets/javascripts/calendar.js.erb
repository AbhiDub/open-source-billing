//$(document).ajaxSend(function(e, xhr, options) {
//    var token = $("meta[name='csrf-token']").attr("content");
//    xhr.setRequestHeader("X-CSRF-Token", token);
//});

function init_fullcalendar(){
    // initialize the calendar...
    $('#calendar').fullCalendar({
        dayClick: function(date, jsEvent, view) {
            $.ajax({
                dataType: 'script',
                type: 'GET',
                data:{date:date.format()},
                url: '/en/logs'
            });
            $('#log_date').val(date.format())

            //alert('Clicked on: ' + date.format());
        },
        events: '/logs/events.json'
        //eventClick: function(event) {
        //window.open(event.showUrl)
        //alert('a day has been clicked!');
        //}

    });
}
$(document).ready(function() {

    init_fullcalendar();
    $('#log_date').val($.datepicker.formatDate('yy-mm-dd', new Date()) );

    jQuery(".log-submit-btn").live("click", function() {
        var date,project_id, task_id, hours;
        date = jQuery("#log_date").val();
        project_id = jQuery("#log_project_id").val();
        task_id = jQuery("#log_task_id").val();
        hours = jQuery("#log_hours").val();
//        $('form#new_log *').filter(':input').each(function(){
//            hidePopover(this);
//        });
        flag = true;
        if (date === "") {
            applyPopover(jQuery("#log_date"), "bottomMiddle", "topLeft", "Select a date from the calendar");
            flag = false;
        } else{ hidePopover(jQuery("#log_date")) }

        if (project_id === "") {
            applyPopover(jQuery("#log_project_id"), "bottomMiddle", "topLeft", "Select a project");
            flag = false;
        } else{ hidePopover(jQuery("#log_project_id")) }
        if (task_id === "") {
            applyPopover(jQuery("#log_task_id"), "bottomMiddle", "topLeft", "Select a task");
            flag = false;
        } else{ hidePopover(jQuery("#log_task_id")) }
        if (hours === "") {
            applyPopover(jQuery("#log_hours"), "bottomMiddle", "topLeft", "Enter hours");
            flag = false;
        } else {
            hidePopover(jQuery("#log_hours"))
        }
        if (flag) {
            return true; //jQuery("form#new_log").get(0).submit();
        }
        else{
            alert('false');
            return false;
        }
    });

    return $(document).on('change', '#log_project_id', function(evt) {
        return $.ajax('/logs/update_tasks', {
            type: 'GET',
            dataType: 'script',
            data: {
                project_id: $("#log_project_id option:selected").val()
            }
        });
    });
});

var applyPopover, hidePopover;
applyPopover = function(elem, position, corner, message) {
    elem.qtip({
        content: {
            text: message
        },
        show: {
            event: false
        },
        hide: {
            event: false
        },
        position: {
            at: position
        },
        style: {
            tip: {
                corner: corner
            }
        }
    });
    elem.qtip().show();
    return elem.focus();
};
hidePopover = function(elem) {
    return elem.qtip("hide");
};